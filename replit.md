# Yomitoku スクリーンリーダー最適化プロジェクト

## 概要
日本語の縦書き・横書き文書画像から、スクリーンリーダーで正しく読み上げられるサーチャブルPDFを生成するツールです。

## プロジェクトの目的
- 日本語フリガナ付き文書をOCR処理
- フリガナと基本テキストを分離
- スクリーンリーダーが基本テキストのみを読み上げるPDFを生成
- 縦書き・横書き両方に対応

## 技術スタック
- **OCRエンジン**: yomitoku (日本語特化Document AI)
- **PDF生成**: PyMuPDF, reportlab
- **UI**: Streamlit
- **画像処理**: Pillow, OpenCV
- **言語**: Python 3.11

## プロジェクト構造
```
/
├── app.py                      # Streamlit メインアプリ
├── src/
│   ├── ocr_processor.py        # yomitoku OCR処理
│   ├── furigana_analyzer.py    # フリガナ検出・分離アルゴリズム
│   └── pdf_generator.py        # スクリーンリーダー対応PDF生成
├── requirements.txt
├── output/                     # 生成されたPDF保存先
└── uploaded_images/            # アップロード画像保存先
```

## 最新の変更
- 2025-11-04: プロジェクト初期設定完了
- 2025-11-04: スクリーンリーダー最適化PDF生成機能の実装完了
- 2025-11-04: フリガナ検出アルゴリズムの実装完了
- 2025-11-04: 日本語フォント対応（Noto Sans CJK）完了

## アーキテクチャの決定
- **PDF生成方式**: PIL ImageDrawでフリガナと基本テキストを画像として描画
  - 視覚レイヤー: 画像（テキストオブジェクトではない）→スクリーンリーダーが読まない
  - 音声レイヤー: 不可視テキスト（render_mode=3）→スクリーンリーダーが読む
- **フリガナ検出**: インデックスベースのトラッキングでKeyError回避
  - フォントサイズ8px未満、ひらがな・カタカナのみで候補検出
  - 縦書き・横書き対応の位置関係分析
- **日本語フォント**: Noto Sans CJK JPをfc-matchで動的に検出・使用

## システム依存関係
- **Noto Sans CJK フォント**: 日本語文字の表示に必須
  - インストール済み: `noto-fonts-cjk-sans`
  - PDF生成時にfc-matchで自動検出

## 実装の詳細

### フリガナ検出アルゴリズム
1. 小さなフォントサイズ（8px未満）のテキストブロックを検出
2. ひらがな・カタカナのみで構成されているか確認
3. 近接する大きなテキストブロック（基本テキスト）を探索
4. 縦書き・横書きに応じた位置関係で紐付け

### PDF生成アルゴリズム
1. PIL ImageDrawでフリガナと基本テキストを画像に描画
2. 画像をPDFページに埋め込み（視覚的に表示、スクリーンリーダー非対応）
3. 基本テキストのみを不可視テキストレイヤー（render_mode=3）に配置
4. スクリーンリーダーは不可視レイヤーのテキストのみを読み上げ

## 使用方法
```bash
streamlit run app.py
```
